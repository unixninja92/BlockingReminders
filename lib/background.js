// Generated by CoffeeScript 1.9.1
(function() {
  var blocker;

  blocker = new Blocker();

  this.getBlocker = function() {
    return blocker;
  };

  this.getJson = function() {
    var cookie, xhr;
    console.log("Hey there ;)");
    xhr = new XMLHttpRequest();
    cookie = null;
    chrome.cookies.get({
      url: "http://blocker.obscure.systems/",
      name: "token"
    }, function(cook) {
      cookie = cook.value;
      if (cookie == null) {
        blocker.clearList();
        return;
      }
      xhr.open("GET", "http://blocker.obscure.systems/get-active-todos", true);
      xhr.setRequestHeader("Authorization", "Bearer " + cookie);
      xhr.onreadystatechange = function() {
        var newJson;
        if (xhr.responseText != null) {
          newJson = JSON.parse(xhr.responseText).todos[0];
          console.log(newJson);
          return blocker.parseJson(newJson);
        }
      };
      return xhr.send();
    });
    return xhr;
  };

  getJson();

  setInterval(getJson, 6000);

  chrome.tabs.onCreated.addListener(function(tab) {
    console.log("Hey!");
    return blocker.run(tab);
  });

  chrome.tabs.onActivated.addListener(function(info) {
    return chrome.tabs.get(info.tabId, function(tab) {
      console.log("Hey :/");
      return blocker.run(tab);
    });
  });

  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    if (changeInfo.status === 'loading') {
      console.log("Yo");
      return blocker.run(tab);
    }
  });

}).call(this);
